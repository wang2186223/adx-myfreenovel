# 每日邮件报告设置指南

## 📋 已完成的修改

### 1. 数据清理周期调整
- ✅ 将数据保留时间从 **7天** 改为 **3天**
- 旧数据会在第4天自动删除

### 2. 每日邮件报告功能
- ✅ 收件人: `jannatjahan36487@gmail.com`
- ✅ 发送时间: 每天北京时间 **01:00**
- ✅ 邮件内容包括:
  - 📊 总体统计（总访问量、活跃天数等）
  - 📈 当日详细数据（页面访问、广告引导触发）
  - 📚 书籍访问统计（章节访问量、独立IP数）
  - 📎 Excel附件（包含所有详细数据表）

## 🚀 设置步骤

### 步骤1: 更新 Google Apps Script 代码

1. 打开 Google Sheets: https://docs.google.com/spreadsheets/d/1hO9dXSL6mG9UJlhSgVp-5nyKk3YGtU7hg205iortWek
2. 点击 **扩展程序 (Extensions)** → **Apps Script**
3. 将 `analytics-script.js` 的完整内容复制粘贴到编辑器中
4. 点击 **保存** (💾 图标)

### 步骤2: 测试邮件发送（立即测试）

1. 在 Apps Script 编辑器中，找到顶部的函数选择下拉框
2. 选择函数: **`testEmailReport`**
3. 点击 **运行** (▶️ 图标)
4. **首次运行时**，会提示授权:
   - 点击 "审核权限"
   - 选择您的 Google 账号
   - 点击 "高级" → "前往[项目名称]（不安全）"
   - 点击 "允许"
5. 查看执行日志，确认显示: `✅ 测试邮件发送成功`
6. 检查邮箱 `jannatjahan36487@gmail.com` 是否收到测试邮件

### 步骤3: 设置每日自动发送触发器

1. 在 Apps Script 编辑器左侧，点击 **触发器** (⏰ 图标)
2. 点击右下角的 **+ 添加触发器** 按钮
3. 配置触发器参数:
   ```
   选择要运行的函数: sendDailyEmailReport
   选择部署方式: Head
   选择事件来源: 时间驱动
   选择时间类型: 天定时器
   选择时间: 凌晨1点至2点
   ```
4. 点击 **保存**
5. 再次授权（如果需要）

### 步骤4: 验证触发器设置

1. 返回 **触发器** 页面
2. 确认看到一条新触发器:
   - 函数: `sendDailyEmailReport`
   - 事件: Time-driven, Day timer, 1am-2am
3. 设置完成！

## 📧 邮件内容示例

```
您好，

这是 2025-10-20 的网站访问统计报告。

========== 📊 总体统计 ==========
今日访问量: 1234
总访问量: 56789
活跃天数: 45
平均日访问: 1262

========== 📈 2025-10-20 详细数据 ==========
页面访问次数: 1234
广告引导触发次数: 56

========== 📚 书籍访问统计 ==========
• Heartbreak Billionaire: 456章节访问, 89个独立IP
• My Rejected Mate Regrets: 321章节访问, 67个独立IP

详细数据请查看附件中的Excel文件。

---
此邮件由 NovelVibe Analytics 系统自动发送
发送时间: 2025-10-21 01:00:15
```

## 📎 附件说明

### Excel格式（.xlsx）- 首选方案
- 包含完整的Google Sheets所有标签页
- 可以直接在Excel/WPS中打开
- 保留格式和样式

### CSV格式（.csv）- 备选方案
- 纯文本格式，兼容性最好
- 包含以下内容:
  1. **控制台** - 总体统计数据
  2. **访问详细-[日期]** - 当天所有页面访问记录
  3. **广告引导-[日期]** - 当天所有广告引导触发记录
  4. **统计汇总** - 书籍访问统计汇总

## 🧪 测试函数说明

### `testEmailReport()`
- **用途**: 立即发送一封测试邮件
- **使用场景**: 验证邮件功能是否正常
- **运行方式**: 在 Apps Script 中手动运行

### `sendDailyEmailReport()`
- **用途**: 正式的每日报告函数
- **使用场景**: 通过触发器自动运行
- **运行时间**: 每天北京时间 01:00-02:00

## ⚠️ 注意事项

1. **时区设置**: 
   - 触发器运行时间基于您的 Google 账号时区
   - 确保账号时区设置为 **Asia/Shanghai (UTC+8)**
   - 检查方法: Google Apps Script → 项目设置 → 时区

2. **邮件配额**: 
   - 免费 Google 账号每天最多发送 100 封邮件
   - 当前设置每天只发送 1 封，完全足够

3. **错误通知**: 
   - 如果报告生成失败，会自动发送错误通知邮件
   - 包含详细的错误信息，便于排查问题

4. **数据保留**: 
   - 详细数据保留 **3天**
   - 统计汇总表永久保留
   - 控制台数据永久保留

## 🔧 故障排查

### 问题1: 没有收到邮件
- 检查垃圾邮件文件夹
- 查看 Apps Script 执行日志（触发器旁边的三个点 → 执行）
- 确认触发器状态为"已启用"

### 问题2: Excel附件为空或无附件
- 确认当天有数据记录
- 查看执行日志中的错误信息
- 手动运行 `testEmailReport()` 查看详细错误

### 问题3: 邮件发送时间不对
- 检查 Google 账号时区设置
- 触发器时间为时间范围（1-2点），不是精确时间
- Google 会在该时间范围内随机选择一个时间执行

## 📞 需要帮助？

如果遇到问题，请检查:
1. Apps Script 执行日志
2. 触发器执行历史记录
3. Google Sheets 中的数据是否正常更新

---
更新时间: 2025-10-20
